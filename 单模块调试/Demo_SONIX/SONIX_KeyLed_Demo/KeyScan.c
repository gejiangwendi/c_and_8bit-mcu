/**********************************************************************************************************
File name:	KeyScan.c
Author:		lian_jin
Data:		2011/9/16
Email:		lian_jin@sonix.com.cn

**********************************************************************************************************/

//---------------------------------------------------------------------------------------------------------

#include	"User.h"
#include	"Key.h"

uint		KeyStatus;
uint		KeyInbuf;
uint		KeyCvtbuf;
uint		KeyChkbuf;
uint		KeyChat;
uint		KeyFIFO;

bit			Fkeyin;
bit			FkeyCvtOK;
bit			F1ms;
//---------------------------------------------------------------------------------------------------------

/**********************************************************************************************************
按键扫描程序:	void	KeyScan(void)
程  序 功 能：	读取按键状态，并存相应的键值早 KeyFIFO 中，以便后续处理
**********************************************************************************************************/
void	KeyScan(void)
{
	KeyIn();
	KeyChk();
	KeyCvt();				
}
/**********************************************************************************************************
按键扫描子程序：	void	KeyIn(svoid)
程  序  功  能：	读取I/O状态。
**********************************************************************************************************/
void	KeyIn(void)
{
	KeyInbuf = ~KeyPort;
}
/**********************************************************************************************************
按键扫描子程序：	void	KeyChk(void)
程  序  功  能：	判断按键是否有动作；如果消抖动完成，则置位 FkeyCvtOK=1
**********************************************************************************************************/
void	KeyChk(void)
{
	if(KeyChkbuf != KeyInbuf)	
	{	
		KeyChkbuf = KeyInbuf;
		Fkeyin = 1;
		KeyChat = KeyBounceTime;
	}
	if((Fkeyin == 1)&&(KeyChat == 0))							 
	{
			Fkeyin  = 0;
			FkeyCvtOK = 1;
			KeyCvtbuf = KeyChkbuf;
		
	}
}	
/**********************************************************************************************************
键值转换程序：	void	KeyCvt(void)
程 序 功 能 ：  键值存入KeyFIFO中
**********************************************************************************************************/
void	KeyCvt(void)
{
	if(FkeyCvtOK)
	{
		FkeyCvtOK = 0;
		KeyFIFO = KeyCvtbuf;
	}
}
